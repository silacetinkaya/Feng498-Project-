-- ==============================
-- TABLES
-- ==============================

-- USERS TABLE
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255),
    password VARCHAR(255),
    role_type VARCHAR(50),
    registration_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    address VARCHAR(255),
    full_name VARCHAR(255)
);

-- BUSINESS TABLE
CREATE TABLE business (
    shop_id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    owner_id INTEGER NOT NULL,
    address VARCHAR(255),
    tel_no VARCHAR(50),
    description TEXT,
    business_hours TEXT,
    CONSTRAINT fk_business_owner FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
);

-- BUSINESS_HOURS TABLE
CREATE TABLE business_hours (
    id SERIAL PRIMARY KEY,
    business_id INTEGER NOT NULL,
    open_hour TIME,
    close_hour TIME,
    day_of_week VARCHAR(20),
    is_closed BOOLEAN DEFAULT FALSE,
    created TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_hours_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

-- CATEGORIES TABLE
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    type VARCHAR(100),
    business_id INTEGER,
    CONSTRAINT fk_categories_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

-- ADDRESS TABLE
CREATE TABLE address (
    id SERIAL PRIMARY KEY,
    business_id INTEGER,
    user_id INTEGER,
    address VARCHAR(255),
    city VARCHAR(100),
    neighbourhood VARCHAR(100),
    country VARCHAR(100),
    CONSTRAINT fk_address_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE,
    CONSTRAINT fk_address_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- REVIEWS TABLE
CREATE TABLE reviews (
    review_id SERIAL PRIMARY KEY,
    comments TEXT,
    rank INTEGER,
    user_id INTEGER NOT NULL,
    business_id INTEGER NOT NULL,
    photos TEXT,
    time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_reviews_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_reviews_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

-- PHOTOS TABLE
CREATE TABLE photos (
    photo_id SERIAL PRIMARY KEY,
    image_url VARCHAR(255),
    review_id INTEGER,
    business_id INTEGER,
    CONSTRAINT fk_photos_review FOREIGN KEY (review_id) REFERENCES reviews(review_id) ON DELETE CASCADE,
    CONSTRAINT fk_photos_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

-- PRODUCTS TABLE
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    business_id INTEGER NOT NULL,
    description TEXT,
    product_prices DECIMAL,
    categories VARCHAR(100),
    available BOOLEAN DEFAULT TRUE,
    name VARCHAR(255),
    CONSTRAINT fk_products_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

-- PRODUCT_PRICES TABLE
CREATE TABLE product_prices (
    id SERIAL PRIMARY KEY,
    product_id INTEGER,
    price DECIMAL,
    is_negotiable BOOLEAN DEFAULT FALSE,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_product_prices_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

-- FAVORITES TABLE
CREATE TABLE favorites (
    id SERIAL PRIMARY KEY,
    product_id INTEGER,
    user_id INTEGER,
    CONSTRAINT fk_favorites_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE,
    CONSTRAINT fk_favorites_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- CHATS TABLE
CREATE TABLE chats (
    id SERIAL PRIMARY KEY,
    business_id INTEGER,
    user_id INTEGER,
    message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_chats_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE,
    CONSTRAINT fk_chats_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- MESSAGES TABLE
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    content TEXT,
    user_id INTEGER,
    owner_id INTEGER,
    CONSTRAINT fk_messages_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_messages_owner FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
);

-- OFFERS TABLE
CREATE TABLE offers (
    id SERIAL PRIMARY KEY,
    business_id INTEGER,
    user_id INTEGER,
    chat_id INTEGER,
    offered_price DECIMAL,
    status VARCHAR(50),
    created_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_offers_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE,
    CONSTRAINT fk_offers_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_offers_chat FOREIGN KEY (chat_id) REFERENCES chats(id) ON DELETE CASCADE
);

-- REPORTS TABLE
CREATE TABLE reports (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    reason TEXT,
    status VARCHAR(50),
    report_type VARCHAR(50),
    CONSTRAINT fk_reports_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- NOTIFICATIONS TABLE
CREATE TABLE notifications (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    type VARCHAR(50),
    content TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_notifications_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

-- BEST_OF_DAY TABLE
CREATE TABLE best_of_day (
    id SERIAL PRIMARY KEY,
    business_id INTEGER,
    date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_best_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

-- 1. Add product_id to the existing PHOTOS table
ALTER TABLE photos ADD COLUMN product_id INTEGER;
ALTER TABLE photos ADD CONSTRAINT fk_photos_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE;

-- 2. Ensure CATEGORIES table has unique types to avoid duplicates
ALTER TABLE categories ADD CONSTRAINT unique_category_type UNIQUE (type);

-- Table to store Business Responses
CREATE TABLE review_responses (
    id SERIAL PRIMARY KEY,
    review_id INTEGER NOT NULL UNIQUE, -- Only 1 response per review
    business_id INTEGER NOT NULL,
    response_text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_response_review FOREIGN KEY (review_id) REFERENCES reviews(review_id) ON DELETE CASCADE,
    CONSTRAINT fk_response_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);
ALTER TABLE reviews ADD COLUMN is_approved BOOLEAN DEFAULT FALSE;
ALTER TABLE review_responses ADD COLUMN is_approved BOOLEAN DEFAULT FALSE;

-- 2. Create Price List Table
CREATE TABLE price_lists (
    id SERIAL PRIMARY KEY,
    business_id INTEGER NOT NULL,
    image_url VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_pricelist_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

ALTER TABLE address
ADD COLUMN district VARCHAR(100);

ALTER TABLE business
ADD COLUMN latitude NUMERIC(9,6);

ALTER TABLE business
ADD COLUMN longitude NUMERIC(9,6);

ALTER TABLE business
ADD COLUMN category VARCHAR(100);


CREATE TABLE product_favorites (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    product_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT fk_prod_fav_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_prod_fav_product FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE
);

CREATE TABLE business_favorites (
    id SERIAL PRIMARY KEY,
    user_id INT NOT NULL,
    business_id INT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT fk_biz_fav_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    CONSTRAINT fk_biz_fav_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);
DROP TABLE IF EXISTS favorites;

ALTER TABLE photos ADD COLUMN is_approved BOOLEAN DEFAULT FALSE;
ALTER TABLE price_lists ADD COLUMN is_approved BOOLEAN DEFAULT FALSE;
ALTER TABLE reviews ADD CONSTRAINT unique_user_business_review UNIQUE (user_id, business_id);
ALTER TABLE business ADD COLUMN is_editors_choice BOOLEAN DEFAULT FALSE;

CREATE TABLE business_photos (
    id SERIAL PRIMARY KEY,
    business_id INTEGER NOT NULL,
    image_url VARCHAR(255) NOT NULL,
    is_approved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    CONSTRAINT fk_business_photos_business FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE
);

ALTER TABLE products
ADD COLUMN original_price DECIMAL,
ADD COLUMN discounted_price DECIMAL,
ADD COLUMN discount_percent INT,
ADD COLUMN is_discounted BOOLEAN DEFAULT FALSE;

ALTER TABLE offers ADD COLUMN product_id INTEGER;
ALTER TABLE offers ADD CONSTRAINT fk_offers_product
FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE;

ALTER TABLE offers ADD COLUMN note TEXT;

ALTER TABLE offers ADD COLUMN counter_price DECIMAL;

ALTER TABLE offers ALTER COLUMN status SET DEFAULT 'pending';
UPDATE offers SET status='pending' WHERE status IS NULL;

WITH ranked AS (
  SELECT
    id,
    business_id,
    user_id,
    MAX(id) OVER (PARTITION BY business_id, user_id) AS keep_id,
    ROW_NUMBER() OVER (PARTITION BY business_id, user_id ORDER BY id DESC) AS rn
  FROM chats
)
UPDATE messages m
SET chat_id = r.keep_id
FROM ranked r
WHERE m.chat_id = r.id AND r.rn > 1;

WITH ranked AS (
  SELECT
    id,
    business_id,
    user_id,
    MAX(id) OVER (PARTITION BY business_id, user_id) AS keep_id,
    ROW_NUMBER() OVER (PARTITION BY business_id, user_id ORDER BY id DESC) AS rn
  FROM chats
)
UPDATE offers o
SET chat_id = r.keep_id
FROM ranked r
WHERE o.chat_id = r.id AND r.rn > 1;

WITH ranked AS (
  SELECT
    id,
    ROW_NUMBER() OVER (PARTITION BY business_id, user_id ORDER BY id DESC) AS rn
  FROM chats
)
DELETE FROM chats c
USING ranked r
WHERE c.id = r.id AND r.rn > 1;
ALTER TABLE chats
ADD CONSTRAINT unique_chat_pair UNIQUE (business_id, user_id);
-- OFFERS: product_id / note / counter_price garanti
ALTER TABLE offers ADD COLUMN IF NOT EXISTS product_id INTEGER;
ALTER TABLE offers ADD COLUMN IF NOT EXISTS note TEXT;
ALTER TABLE offers ADD COLUMN IF NOT EXISTS counter_price DECIMAL;

-- FK (yoksa ekle)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'fk_offers_product'
  ) THEN
    ALTER TABLE offers
      ADD CONSTRAINT fk_offers_product
      FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE;
  END IF;
END$$;

-- OFFERS status default
ALTER TABLE offers ALTER COLUMN status SET DEFAULT 'pending';
UPDATE offers SET status='pending' WHERE status IS NULL;

-- MESSAGES: chat-based mesajlaşma kolonları garanti
ALTER TABLE messages ADD COLUMN IF NOT EXISTS chat_id INTEGER;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS sender_type VARCHAR(20);
ALTER TABLE messages ADD COLUMN IF NOT EXISTS sender_ref_id INTEGER;
ALTER TABLE messages ADD COLUMN IF NOT EXISTS created_at TIMESTAMP DEFAULT NOW();
ALTER TABLE messages ADD COLUMN IF NOT EXISTS is_read BOOLEAN DEFAULT FALSE;

-- messages.chat_id FK (yoksa ekle)
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_constraint WHERE conname = 'fk_messages_chat'
  ) THEN
    ALTER TABLE messages
      ADD CONSTRAINT fk_messages_chat
      FOREIGN KEY (chat_id) REFERENCES chats(id) ON DELETE CASCADE;
  END IF;
END$$;

-- Index (performans)
CREATE INDEX IF NOT EXISTS idx_messages_chat_id ON messages(chat_id);
CREATE INDEX IF NOT EXISTS idx_offers_chat_id ON offers(chat_id);

-- ==============================
-- ADS (Bronze / Silver / Gold)
-- PostgreSQL
-- ==============================

-- 1) Paketler
CREATE TABLE IF NOT EXISTS ad_packages (
  id              SERIAL PRIMARY KEY,
  code            VARCHAR(20) NOT NULL UNIQUE,     -- BRONZE / SILVER / GOLD
  name            VARCHAR(50) NOT NULL,            -- Bronze / Silver / Gold
  monthly_price   NUMERIC(10,2) NOT NULL DEFAULT 0,
  daily_user_cap  INT NOT NULL DEFAULT 3,          -- user başına günlük max gösterim
  priority_weight INT NOT NULL DEFAULT 1,          -- Gold daha yüksek
  show_home       BOOLEAN NOT NULL DEFAULT TRUE,   -- Bronze+
  show_search     BOOLEAN NOT NULL DEFAULT FALSE,  -- Silver+
  show_map        BOOLEAN NOT NULL DEFAULT FALSE,  -- Gold+
  is_active       BOOLEAN NOT NULL DEFAULT TRUE,
  created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- updated_at otomatik güncellensin (trigger’sız basit kullanım için biz update’lerde set edeceğiz)
-- istersen trigger da ekleriz ama şart değil.

-- 2) Abonelik (işletmenin satın aldığı paket)
CREATE TABLE IF NOT EXISTS ad_subscriptions (
  id           SERIAL PRIMARY KEY,
  business_id  INTEGER NOT NULL,
  package_id   INTEGER NOT NULL,
  status       VARCHAR(20) NOT NULL DEFAULT 'active', -- active/expired/cancelled
  starts_at    TIMESTAMP NOT NULL DEFAULT NOW(),
  ends_at      TIMESTAMP NOT NULL,
  created_at   TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at   TIMESTAMP NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_ad_sub_business
    FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE,
  CONSTRAINT fk_ad_sub_package
    FOREIGN KEY (package_id) REFERENCES ad_packages(id) ON DELETE RESTRICT
);

CREATE INDEX IF NOT EXISTS idx_ad_sub_business ON ad_subscriptions(business_id);
CREATE INDEX IF NOT EXISTS idx_ad_sub_status_end ON ad_subscriptions(status, ends_at);

-- 3) Gösterimler (daily cap = 3 için)
CREATE TABLE IF NOT EXISTS ad_impressions (
  id              BIGSERIAL PRIMARY KEY,
  subscription_id INTEGER NOT NULL,
  business_id     INTEGER NOT NULL,
  user_id         INTEGER NOT NULL,
  impression_date DATE NOT NULL DEFAULT CURRENT_DATE,  -- gün bazlı limit
  placement       VARCHAR(10) NOT NULL,                -- home/search/map
  cnt             INT NOT NULL DEFAULT 0,
  created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at      TIMESTAMP NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_imp_sub
    FOREIGN KEY (subscription_id) REFERENCES ad_subscriptions(id) ON DELETE CASCADE,
  CONSTRAINT fk_imp_business
    FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE,
  CONSTRAINT fk_imp_user
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

  CONSTRAINT ck_imp_placement CHECK (placement IN ('home','search','map')),
  CONSTRAINT uq_imp UNIQUE (subscription_id, user_id, impression_date, placement)
);

CREATE INDEX IF NOT EXISTS idx_imp_business_date ON ad_impressions(business_id, impression_date);
CREATE INDEX IF NOT EXISTS idx_imp_user_date ON ad_impressions(user_id, impression_date);

-- 4) Tıklamalar (opsiyonel ama çok iyi durur)
CREATE TABLE IF NOT EXISTS ad_clicks (
  id              BIGSERIAL PRIMARY KEY,
  subscription_id INTEGER NOT NULL,
  business_id     INTEGER NOT NULL,
  user_id         INTEGER NOT NULL,
  placement       VARCHAR(10) NOT NULL,
  created_at      TIMESTAMP NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_click_sub
    FOREIGN KEY (subscription_id) REFERENCES ad_subscriptions(id) ON DELETE CASCADE,
  CONSTRAINT fk_click_business
    FOREIGN KEY (business_id) REFERENCES business(shop_id) ON DELETE CASCADE,
  CONSTRAINT fk_click_user
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,

  CONSTRAINT ck_click_placement CHECK (placement IN ('home','search','map'))
);

CREATE INDEX IF NOT EXISTS idx_click_business ON ad_clicks(business_id);
CREATE INDEX IF NOT EXISTS idx_click_user ON ad_clicks(user_id);

-- 5) Paket seed (Bronze / Silver / Gold)
INSERT INTO ad_packages (code, name, monthly_price, daily_user_cap, priority_weight, show_home, show_search, show_map)
VALUES
  ('BRONZE', 'Bronze', 199.00, 3, 1, TRUE,  FALSE, FALSE),
  ('SILVER', 'Silver', 399.00, 3, 2, TRUE,  TRUE,  FALSE),
  ('GOLD',   'Gold',   699.00, 3, 3, TRUE,  TRUE,  TRUE)
ON CONFLICT (code) DO UPDATE SET
  name = EXCLUDED.name,
  monthly_price = EXCLUDED.monthly_price,
  daily_user_cap = EXCLUDED.daily_user_cap,
  priority_weight = EXCLUDED.priority_weight,
  show_home = EXCLUDED.show_home,
  show_search = EXCLUDED.show_search,
  show_map = EXCLUDED.show_map,
  is_active = TRUE,
  updated_at = NOW();

-- ==============================
-- Gösterim sayma (daily cap için)
-- ==============================
-- Örnek kullanım:
-- INSERT INTO ad_impressions (subscription_id,business_id,user_id,impression_date,placement,cnt)
-- VALUES ($1,$2,$3,CURRENT_DATE,'home',1)
-- ON CONFLICT (subscription_id,user_id,impression_date,placement)
-- DO UPDATE SET cnt = ad_impressions.cnt + 1, updated_at = NOW();

